name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [18, 20, 22]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all MCP servers
        run: npm run build

      - name: Run Reddit Search tests
        run: npm run test:reddit
        continue-on-error: true  # Reddit API may rate-limit in CI

      - name: Verify server builds
        shell: bash
        run: |
          echo "Checking built server files..."
          
          # Check uipath-docs
          if [ -f "mcp-servers/uipath-docs/dist/index.js" ]; then
            echo "‚úÖ uipath-docs built successfully"
          else
            echo "‚ùå uipath-docs build missing"
            exit 1
          fi
          
          # Check youtube-scraper
          if [ -f "mcp-servers/youtube-scraper/dist/index.js" ]; then
            echo "‚úÖ youtube-scraper built successfully"
          else
            echo "‚ùå youtube-scraper build missing"
            exit 1
          fi
          
          # Check local-knowledge
          if [ -f "mcp-servers/local-knowledge/dist/index.js" ]; then
            echo "‚úÖ local-knowledge built successfully"
          else
            echo "‚ùå local-knowledge build missing"
            exit 1
          fi
          
          # Check reddit-search
          if [ -f "mcp-servers/reddit-search/dist/index.js" ]; then
            echo "‚úÖ reddit-search built successfully"
          else
            echo "‚ùå reddit-search build missing"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All MCP servers built successfully!"

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check TypeScript compilation
        run: npm run build

      - name: Check for TypeScript errors
        run: |
          echo "Checking TypeScript strict mode compliance..."
          
          # Run tsc with noEmit to check for type errors without building
          cd mcp-servers/uipath-docs && npx tsc --noEmit || true
          cd ../youtube-scraper && npx tsc --noEmit || true
          cd ../local-knowledge && npx tsc --noEmit || true
          cd ../reddit-search && npx tsc --noEmit || true
          
          echo "‚úÖ TypeScript check complete"

  python-check:
    name: Python Scripts Check
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Check Python syntax
        shell: bash
        run: |
          echo "Checking Python script syntax..."
          
          # Check transcribe-video.py
          python -m py_compile scripts/transcribe-video.py
          echo "‚úÖ transcribe-video.py syntax OK"
          
          # Check batch-transcribe.py
          python -m py_compile scripts/batch-transcribe.py
          echo "‚úÖ batch-transcribe.py syntax OK"
          
          echo ""
          echo "‚úÖ All Python scripts have valid syntax!"

      - name: Check Python imports (dry run)
        shell: bash
        run: |
          echo "Checking Python imports..."
          
          # Test import of standard library modules used
          python -c "
          import os
          import sys
          import json
          import logging
          import platform
          import subprocess
          import argparse
          from pathlib import Path
          from datetime import datetime
          print('All standard library imports available')
          "

  setup-check:
    name: Setup Script Check
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        # Windows excluded due to potential path issues in CI
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run setup check
        run: node scripts/setup.js --check

  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate Documentation
        shell: bash
        run: |
          echo "üîç Validating documentation files..."
          echo ""
          
          errors=0
          warnings=0
          validated=0
          skipped=0
          
          # Files to skip (templates, indexes, etc.)
          skip_patterns="template.md|README.md"
          
          # Validate docs/ markdown files (excluding ADR templates/indexes)
          for file in docs/*.md docs/**/*.md; do
            if [ -f "$file" ]; then
              # Skip template and index files
              if echo "$file" | grep -qE "$skip_patterns"; then
                echo "‚è≠Ô∏è  Skipping $file (template/index)"
                skipped=$((skipped + 1))
                continue
              fi
              
              echo "üìÑ Validating $file..."
              result=$(node validators/validate-documentation.js "$file" 2>&1) || true
              
              if echo "$result" | grep -q "Score:"; then
                score=$(echo "$result" | grep -oE "Score: [0-9]+" | grep -oE "[0-9]+")
                if [ "$score" -lt 50 ]; then
                  echo "  ‚ùå Score: $score/100 (minimum: 50)"
                  errors=$((errors + 1))
                elif [ "$score" -lt 70 ]; then
                  echo "  ‚ö†Ô∏è  Score: $score/100 (recommended: 70)"
                  warnings=$((warnings + 1))
                else
                  echo "  ‚úÖ Score: $score/100"
                fi
                validated=$((validated + 1))
              fi
            fi
          done
          
          # Validate knowledge/custom markdown files
          for file in knowledge/custom/*.md; do
            if [ -f "$file" ]; then
              echo "üìÑ Validating $file..."
              result=$(node validators/validate-documentation.js "$file" 2>&1) || true
              
              if echo "$result" | grep -q "Score:"; then
                score=$(echo "$result" | grep -oE "Score: [0-9]+" | grep -oE "[0-9]+")
                if [ "$score" -lt 50 ]; then
                  echo "  ‚ùå Score: $score/100 (minimum: 50)"
                  errors=$((errors + 1))
                elif [ "$score" -lt 70 ]; then
                  echo "  ‚ö†Ô∏è  Score: $score/100 (recommended: 70)"
                  warnings=$((warnings + 1))
                else
                  echo "  ‚úÖ Score: $score/100"
                fi
                validated=$((validated + 1))
              fi
            fi
          done
          
          echo ""
          echo "======================================"
          echo "üìä Validation Summary"
          echo "======================================"
          echo "Files validated: $validated"
          echo "Files skipped: $skipped"
          echo "Errors (score < 50): $errors"
          echo "Warnings (score < 70): $warnings"
          echo ""
          
          if [ $errors -gt 0 ]; then
            echo "‚ùå Documentation validation FAILED"
            exit 1
          else
            echo "‚úÖ Documentation validation passed"
          fi

  release-ready:
    name: Release Ready Check
    runs-on: ubuntu-latest
    needs: [build, lint, python-check, validate-docs]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          echo "Checking required files..."
          
          required_files=(
            "README.md"
            "QUICKSTART.md"
            "package.json"
            "package-lock.json"
            "scripts/setup.js"
            "scripts/transcribe-video.py"
            "scripts/batch-transcribe.py"
            "mcp-servers/uipath-docs/package.json"
            "mcp-servers/youtube-scraper/package.json"
            "mcp-servers/local-knowledge/package.json"
            "mcp-servers/reddit-search/package.json"
            "docs/mcp-configuration.md"
            "docs/youtube-scraping.md"
            "docs/usecase-workflow.md"
          )
          
          all_found=true
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå $file MISSING"
              all_found=false
            fi
          done
          
          if [ "$all_found" = false ]; then
            echo ""
            echo "‚ùå Some required files are missing!"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ All required files present!"

      - name: Check documentation completeness
        run: |
          echo "Checking documentation completeness..."
          
          # Check README has essential sections
          if grep -q "Schnellstart\|Quick Start" README.md && \
             grep -q "MCP Server\|MCP-Server" README.md && \
             grep -q "npm run" README.md; then
            echo "‚úÖ README.md has required sections"
          else
            echo "‚ùå README.md is incomplete"
            exit 1
          fi
          
          # Check QUICKSTART has platform guides
          if grep -q "Windows" QUICKSTART.md && \
             grep -q "macOS\|Mac" QUICKSTART.md; then
            echo "‚úÖ QUICKSTART.md has platform guides"
          else
            echo "‚ùå QUICKSTART.md missing platform guides"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Documentation is complete!"

      - name: Summary
        run: |
          echo "======================================"
          echo "üéâ Release Ready Check PASSED"
          echo "======================================"
          echo ""
          echo "The repository is ready for team handoff:"
          echo "  ‚úÖ All MCP servers build successfully"
          echo "  ‚úÖ TypeScript compiles without errors"
          echo "  ‚úÖ Python scripts have valid syntax"
          echo "  ‚úÖ All required files present"
          echo "  ‚úÖ Documentation is complete"
          echo ""
          echo "Next steps:"
          echo "  1. git push to trigger CI"
          echo "  2. Share repository with team"
          echo "  3. Have team run: npm run setup"
